# 🔧 故障排除指南

## 🚨 常见问题及解决方案

### 0. CORS跨域问题（已解决）

**问题描述：** 配置了正确的API密钥，但测试连接时出现CORS错误
```
Access to XMLHttpRequest has been blocked by CORS policy
```

**解决方案：**
- ✅ **已修复**：项目已配置代理服务器，自动处理跨域问题
- 端点地址会根据模型类型自动选择：
  - 百炼大模型：使用 `/api/bailian` 代理
  - 通义千问：使用 `/api/aliyun` 代理
- 用户无需手动配置端点地址，系统会自动处理

**如果仍有问题：**
1. 确保使用最新版本的代码
2. 重启开发服务器：`npm run dev`
3. 检查浏览器控制台是否有其他错误

### 1. API密钥显示问题

**问题描述：** 点击"显示"按钮后，API密钥仍然不显示

**解决方案：**
- ✅ 已修复：现在使用条件渲染来正确显示/隐藏密钥
- 如果仍有问题，请检查浏览器控制台是否有错误信息

### 2. API连接测试失败

**问题描述：** 配置了正确的API密钥，但测试连接仍然失败

**可能原因和解决方案：**

#### 原因1：API密钥格式问题
- **检查项：** API密钥是否以 `sk-` 开头
- **解决方案：** 确保复制完整的API密钥，包括 `sk-` 前缀

#### 原因2：API密钥无效或过期
- **检查项：** 在阿里云控制台验证API密钥是否有效
- **解决方案：** 重新生成API密钥

#### 原因3：网络连接问题
- **检查项：** 网络连接是否正常
- **解决方案：** 检查网络设置，尝试访问其他网站

#### 原因4：API服务不可用
- **检查项：** 阿里云通义千问服务是否正常
- **解决方案：** 查看阿里云服务状态页面

#### 原因5：账户余额不足
- **检查项：** 阿里云账户是否有足够余额
- **解决方案：** 充值或检查计费设置

### 3. API令牌认证失败

**问题描述：** 连接测试成功，但生成故事时出现"API令牌认证失败"错误

**错误信息：**
```json
{
  "Code": "100016",
  "Message": "API令牌认证失败",
  "Success": false
}
```

**解决方案：**

#### 步骤1：验证API密钥
1. 打开设置页面 (`/settings`)
2. 使用"API调试工具"检查配置
3. 点击"显示完整密钥"确认密钥正确
4. 确保密钥以 `sk-` 开头且长度正确

#### 步骤2：检查模型配置
1. 确认选择了正确的模型：
   - 百炼大模型：`bailian-v1`
   - 通义千问：`qwen-turbo`、`qwen-plus`、`qwen-max`
2. 端点地址会自动处理，无需手动修改

#### 步骤3：重新生成API密钥
1. 登录[百炼大模型控制台](https://bailian.console.aliyun.com/?spm=a2c4g.11186623.aillm.3.4f934e7aN2boLD&tab=api&scm=20140722.S_%E6%88%91%E7%9A%84%E7%99%BE%E7%82%BC%E5%A4%A7%E6%A8%A1%E5%9E%8BAPI%E5%AF%86%E9%92%A5%E5%9C%A8%E5%93%AA%E9%87%8C._.RL_%E6%88%91%E7%9A%84%E7%99%BE%E7%82%BC%E5%A4%A7%E6%A8%A1%E5%9E%8BAPI%E5%AF%86%E9%92%A5%E5%9C%A8%E5%93%AA%E9%87%8C-LOC_aillm-OR_chat-V_3-RC_llm#/api)
2. 删除旧的API密钥
3. 创建新的API密钥
4. 在应用中重新配置

#### 步骤4：检查账户权限
1. 确认账户有API调用权限
2. 检查账户余额是否充足
3. 确认百炼大模型服务已开通

#### 步骤5：使用官方配置指南
参考 [BAILIAN_SETUP_GUIDE.md](./BAILIAN_SETUP_GUIDE.md) 获取完整的配置步骤

### 4. 使用调试工具

**步骤：**
1. 打开设置页面 (`/settings`)
2. 使用"API调试工具"检查配置
3. 点击"检查配置"查看详细信息
4. 点击"测试连接"验证API
5. 查看浏览器控制台的详细错误信息

### 4. 浏览器控制台调试

**打开控制台：**
- Chrome/Edge: 按 `F12` 或 `Ctrl+Shift+I`
- Firefox: 按 `F12` 或 `Ctrl+Shift+I`
- Safari: 按 `Cmd+Option+I`

**查看错误信息：**
- 在 Console 标签页查看错误信息
- 在 Network 标签页查看API请求详情

## 🔍 详细调试步骤

### 步骤1：验证API密钥
```bash
# 检查API密钥格式
# 正确格式：sk-xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
# 长度：通常40-50个字符
```

### 步骤2：测试网络连接
```bash
# 测试到阿里云API的连接
curl -X POST https://dashscope.aliyuncs.com/api/v1/services/aigc/text-generation/generation \
  -H "Authorization: Bearer YOUR_API_KEY" \
  -H "Content-Type: application/json" \
  -d '{"model":"qwen-turbo","input":{"messages":[{"role":"user","content":"测试"}]}}'
```

### 步骤3：检查API响应
- 查看响应状态码
- 查看响应内容
- 检查错误信息

## 📋 错误代码说明

### HTTP状态码
- **401 Unauthorized**: API密钥无效或已过期
- **403 Forbidden**: API密钥权限不足
- **429 Too Many Requests**: API调用频率超限
- **500 Internal Server Error**: 服务器内部错误

### 常见错误信息
- **"API密钥无效"**: 检查密钥是否正确复制
- **"网络连接失败"**: 检查网络设置
- **"API响应格式错误"**: 可能是API版本问题
- **"超时错误"**: 网络延迟过高

## 🛠️ 修复措施

### 1. 重新配置API密钥
1. 登录阿里云控制台
2. 删除旧的API密钥
3. 创建新的API密钥
4. 在应用中重新配置

### 2. 检查网络设置
1. 确认网络连接正常
2. 检查防火墙设置
3. 尝试使用代理（如果配置了）

### 3. 更新应用
1. 清除浏览器缓存
2. 重新启动应用
3. 重新配置API设置

## 📞 获取帮助

### 1. 查看日志
- 浏览器控制台日志
- 应用调试信息
- 网络请求日志

### 2. 联系支持
- 阿里云技术支持
- 项目GitHub Issues
- 开发者社区

### 3. 提供信息
在寻求帮助时，请提供以下信息：
- 错误信息截图
- 浏览器控制台日志
- API密钥格式（隐藏敏感信息）
- 网络环境信息

## 🔒 安全建议

1. **不要分享API密钥**
2. **定期更换API密钥**
3. **在安全环境中使用**
4. **监控API使用情况**
5. **设置合理的调用限制**

## 📚 相关文档

- [API配置指南](API_CONFIG_GUIDE.md)
- [项目设置说明](SETUP.md)
- [阿里云API文档](https://help.aliyun.com/zh/dashscope/)
- [通义千问服务](https://dashscope.console.aliyun.com/) 